# Sistema de Autenticaci√≥n Mejorado

## Resumen de Mejoras

Se ha implementado un sistema de autenticaci√≥n m√°s seguro y profesional para el Sistema de Producci√≥n.

### Mejoras Implementadas

#### 1. **SecureStorage** - Gesti√≥n Segura de Datos
- ‚úÖ Almacenamiento en `sessionStorage` (se limpia al cerrar pesta√±a)
- ‚úÖ Expiraci√≥n autom√°tica de tokens (8 horas por defecto)
- ‚úÖ Validaci√≥n de integridad de datos
- ‚úÖ Limpieza autom√°tica de datos expirados
- ‚úÖ Minimizaci√≥n de datos guardados
- ‚úÖ Prefijo en keys para evitar conflictos (`sisprod_`)

#### 2. **AuthService Refactorizado**
- ‚úÖ Validaci√≥n de token antes de guardar
- ‚úÖ Manejo robusto de errores
- ‚úÖ M√©todos √∫tiles: `hasRole()`, `hasPermission()`, `getSessionTimeLeft()`
- ‚úÖ Auto-renovaci√≥n de sesi√≥n (`refreshSession()`)
- ‚úÖ Limpieza completa en logout

#### 3. **API Interceptor Mejorado**
- ‚úÖ Auto-inyecci√≥n de token y m√≥dulo ID
- ‚úÖ Renovaci√≥n autom√°tica de sesi√≥n en cada request (keep-alive)
- ‚úÖ Validaci√≥n de sesi√≥n antes de enviar requests
- ‚úÖ Manejo mejorado de errores (401, 403, 404, 422, 5xx)
- ‚úÖ Timeout de 30 segundos

#### 4. **AuthContext Optimizado**
- ‚úÖ Ya no duplica datos en state
- ‚úÖ Obtiene datos directamente de SecureStorage
- ‚úÖ Mejor pantalla de loading
- ‚úÖ Manejo robusto de errores

---

## Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     FRONTEND                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  URL con   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ AuthService ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇSecureStorage ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   token    ‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ                     ‚îÇ        ‚îÇ
‚îÇ                              ‚îÇ                     ‚îÇ        ‚îÇ
‚îÇ                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ        ‚îÇ
‚îÇ                       ‚îÇAuthContext  ‚îÇ             ‚îÇ        ‚îÇ
‚îÇ                       ‚îÇ  (React)    ‚îÇ             ‚îÇ        ‚îÇ
‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ        ‚îÇ
‚îÇ                              ‚îÇ                     ‚îÇ        ‚îÇ
‚îÇ                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ        ‚îÇ
‚îÇ                       ‚îÇ     API     ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ                       ‚îÇ Interceptor ‚îÇ                      ‚îÇ
‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îÇ                              ‚îÇ                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚îÇ HTTP + Headers
                               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     BACKEND (Laravel)                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
‚îÇ            ‚îÇ  ValidateTokenMiddleware ‚îÇ                     ‚îÇ
‚îÇ            ‚îÇ  Valida:                 ‚îÇ                     ‚îÇ
‚îÇ            ‚îÇ  - Bearer Token          ‚îÇ                     ‚îÇ
‚îÇ            ‚îÇ  - X-Modulo-ID           ‚îÇ                     ‚îÇ
‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
‚îÇ                        ‚îÇ                                     ‚îÇ
‚îÇ                        ‚ñº                                     ‚îÇ
‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
‚îÇ            ‚îÇ   Sistema Central (SAC)  ‚îÇ                     ‚îÇ
‚îÇ            ‚îÇ   Validar Token          ‚îÇ                     ‚îÇ
‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Flujo de Autenticaci√≥n

### 1. **Inicializaci√≥n de Sesi√≥n**

```javascript
// 1. Usuario accede desde Sistema Central con URL:
// http://localhost:5174/?token=abc123&modulo_id=1

// 2. AuthContext.initializeSession() se ejecuta
await authService.initializeFromUrl();

// 3. AuthService valida el token con el Sistema Central
const validation = await authService.validateToken(token, moduloId);

// 4. Si es v√°lido, guarda en SecureStorage con expiraci√≥n
secureStorage.setAuthData(token, moduloId, 480); // 8 horas
secureStorage.setSessionData(user); // Datos m√≠nimos

// 5. Limpia URL para seguridad
window.history.replaceState({}, '', '/');
```

### 2. **Request a API**

```javascript
// 1. Usuario hace request (ej: getFrentesTrabajo())
const response = await api.get('/ingenieria/frentes-trabajo');

// 2. API Interceptor valida sesi√≥n
if (!authService.hasValidSession()) {
  authService.logout(); // Redirige si expir√≥
}

// 3. Inyecta headers autom√°ticamente
headers: {
  'Authorization': 'Bearer abc123',
  'X-Modulo-ID': '1'
}

// 4. Renueva expiraci√≥n (keep-alive)
authService.refreshSession();

// 5. Env√≠a request al backend
```

### 3. **Backend Valida**

```php
// ValidateTokenWithCentral Middleware

// 1. Lee headers
$token = $request->bearerToken();
$moduloId = $request->header('X-Modulo-ID');

// 2. Valida con Sistema Central
$response = Http::withToken($token)
    ->post('http://127.0.0.1:8001/api/validar-token', [
        'modulo_id' => $moduloId,
    ]);

// 3. Si v√°lido, adjunta datos al request
$request->merge([
    'auth_user' => $response->json('user'),
    'auth_roles' => $response->json('roles'),
    'auth_permisos' => $response->json('permisos'),
]);
```

---

## Uso en Componentes

### Obtener datos del usuario

```javascript
import { useAuth } from '../core/context/AuthContext';

function MiComponente() {
  const { getUser, getUserInfo } = useAuth();

  const user = getUser(); // { id, nombre, email, roles: [1,2], permisos: [5,8] }
  const userInfo = getUserInfo(); // { nombreCompleto, email, rut }

  return <div>Bienvenido {userInfo.nombreCompleto}</div>;
}
```

### Verificar permisos/roles

```javascript
function AccionesSensibles() {
  const { hasPermission, hasRole } = useAuth();

  if (!hasPermission(5)) {
    return <p>No tienes permiso</p>;
  }

  if (!hasRole(1)) {
    return <p>Solo para administradores</p>;
  }

  return <button>Acci√≥n Sensible</button>;
}
```

### Verificar tiempo de sesi√≥n

```javascript
function SessionTimer() {
  const { getSessionInfo } = useAuth();

  const info = getSessionInfo();
  // { hasSession, user, timeLeft, expiringSoon }

  if (info.expiringSoon) {
    return <div className="alert">‚ö†Ô∏è Tu sesi√≥n expira en {info.timeLeft} minutos</div>;
  }

  return null;
}
```

### Cerrar sesi√≥n

```javascript
function LogoutButton() {
  const { logout } = useAuth();

  return (
    <button onClick={logout}>
      Cerrar Sesi√≥n
    </button>
  );
}
```

---

## Datos Almacenados en sessionStorage

### Antes (Inseguro)
```javascript
// M√∫ltiples keys, datos duplicados, sin expiraci√≥n
sessionStorage.auth_token
sessionStorage.modulo_id
sessionStorage.user
sessionStorage.roles
sessionStorage.permisos
localStorage.user  // ¬°Tambi√©n en localStorage!
localStorage.roles
localStorage.permisos
```

### Ahora (Seguro)
```javascript
// Solo 2 keys con prefijo, datos m√≠nimos, con expiraci√≥n
sessionStorage.sisprod_auth = {
  token: "abc123",
  moduloId: "1",
  expiresAt: 1736957890000,  // Timestamp de expiraci√≥n
  createdAt: 1736929090000
}

sessionStorage.sisprod_session = {
  id: 5,
  nombre: "Juan",
  email: "juan@empresa.com",
  roles: [1, 2],      // Solo IDs, no objetos completos
  permisos: [5, 8, 12]
}
```

---

## Seguridad

### Protecciones Implementadas

1. **Expiraci√≥n autom√°tica**: Token expira en 8 horas (configurable)
2. **Validaci√≥n de integridad**: Verifica estructura de datos antes de usar
3. **Limpieza autom√°tica**: Elimina datos expirados al iniciar
4. **sessionStorage**: Datos se borran al cerrar pesta√±a (mejor que localStorage)
5. **Prefijo en keys**: Evita conflictos con otras aplicaciones
6. **Datos m√≠nimos**: Solo guarda lo esencial
7. **Auto-logout**: Logout autom√°tico en 401/403
8. **Keep-alive**: Renueva sesi√≥n en cada request

### Configuraci√≥n de Expiraci√≥n

```javascript
// Por defecto: 8 horas (480 minutos)
secureStorage.setAuthData(token, moduloId, 480);

// Personalizado: 2 horas
secureStorage.setAuthData(token, moduloId, 120);

// Renovar manualmente
authService.refreshSession(); // Renueva por 8 horas m√°s
```

---

## Debugging

### Ver estado de sesi√≥n en consola

```javascript
import authService from './core/services/auth';

// Ver info completa
console.log(authService.getSessionInfo());
// {
//   hasSession: true,
//   user: { ... },
//   timeLeft: 450,  // minutos
//   expiringSoon: false
// }

// Ver tiempo restante
console.log(authService.getSessionTimeLeft()); // 450 minutos
```

### Ver datos en sessionStorage

```javascript
// En consola del navegador
Object.keys(sessionStorage)
  .filter(k => k.startsWith('sisprod_'))
  .forEach(key => {
    console.log(key, JSON.parse(sessionStorage[key]));
  });
```

---

## Testing en Postman

### Headers requeridos

```
Content-Type: application/json
Authorization: Bearer TU_TOKEN_AQUI
X-Modulo-ID: 1
```

### Ejemplo GET

```
GET http://127.0.0.1:8000/api/dispatch/dumpadas
Headers:
  Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc...
  X-Modulo-ID: 1
```

### Ejemplo POST

```
POST http://127.0.0.1:8000/api/dispatch/dumpadas
Headers:
  Content-Type: application/json
  Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc...
  X-Modulo-ID: 1
Body (raw JSON):
{
  "id_frente_trabajo": 1,
  "fecha": "2025-01-15",
  "ton": 150.50
}
```

---

## Migraci√≥n desde Sistema Antiguo

Si tienes c√≥digo que usa el sistema viejo:

### ‚ùå Antes
```javascript
import authService from './services/auth';

// Estos m√©todos ya no existen
authService.setUserData(user, roles, permisos);
authService.getUserData();
authService.clearUserData();
```

### ‚úÖ Ahora
```javascript
import { useAuth } from './context/AuthContext';

function MiComponente() {
  const { getUser, getUserInfo, hasRole, hasPermission } = useAuth();

  const user = getUser();
  const info = getUserInfo();
  const puedeEditar = hasPermission(8);
}
```

---

## Archivos Modificados

- ‚úÖ `frontend/src/core/services/secureStorage.js` (NUEVO)
- ‚úÖ `frontend/src/core/services/auth.js` (Refactorizado)
- ‚úÖ `frontend/src/core/services/api.js` (Mejorado)
- ‚úÖ `frontend/src/core/context/AuthContext.jsx` (Optimizado)

---

## Preguntas Frecuentes

### ¬øPor qu√© sessionStorage y no localStorage?
sessionStorage se limpia autom√°ticamente al cerrar la pesta√±a, lo que es m√°s seguro para tokens de autenticaci√≥n.

### ¬øQu√© pasa si el token expira?
El sistema detecta tokens expirados autom√°ticamente y hace logout, redirigiendo al Sistema Central.

### ¬øC√≥mo cambiar el tiempo de expiraci√≥n?
En `authService.js` l√≠nea 50, cambiar el valor de `480` (minutos) al deseado.

### ¬øLos datos est√°n encriptados?
Los datos en sessionStorage no est√°n encriptados (JavaScript no puede encriptar de forma 100% segura). La seguridad viene de:
- sessionStorage (se borra al cerrar)
- Expiraci√≥n autom√°tica
- Validaci√≥n con backend en cada request
- Solo guardar datos m√≠nimos

---

## Soporte

Para dudas o problemas, revisar los logs en la consola del navegador. Todos los mensajes est√°n prefijados con emojis para f√°cil identificaci√≥n:

- üîê Inicializaci√≥n
- ‚úÖ √âxito
- ‚ùå Errores
- ‚ö†Ô∏è Advertencias
- üßπ Limpieza
- üîÑ Renovaci√≥n
